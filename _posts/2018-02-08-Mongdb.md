---
title: MongoDB 入门
excerpt: |
  MongoDB 入门
category: DataBase
feature_image: "https://picsum.photos/2560/600?image=872"
---
### MongoDB 基础

默认端口是27017。

配合Docker 一起使用MongoDB：

```
➜  mongodb docker ps -a //查找容器ID
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                      NAMES
c9a85414a61d        mongo               "docker-entrypoint.s…"   7 hours ago         Up 7 hours          0.0.0.0:27017->27017/tcp   some-mongo
➜  mongodb docker exec -it c9a85414a61d /bin/bash // 
root@c9a85414a61d:/# mongo
MongoDB shell version v3.6.2
connecting to: mongodb://127.0.0.1:27017
MongoDB server version: 3.6.2
>
```

### 命令

`db`：查看当前在哪个数据库

```
> db
mydb
```

`use mydb`：切换DB 到mydb 上：

```
> use mydb
switched to db mydb
```

#### 创建用户

```
db.createRole({role:'sysadmin',roles:[],privileges:[{resource:{anyResource:true},actions:['anyAction']}]})
db.createUser({user:'botdb',pwd:'botdb',roles:[{role:'sysadmin',db:'admin'}]})
```

### limit() 方法

`cursor.limit`()

- Use the [`limit()`](https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit) method on a cursor to specify the maximum number of documents the cursor will return. [`limit()`](https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit) is analogous to the `LIMIT` statement in a SQL database.NOTEYou must apply [`limit()`](https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit) to the cursor before retrieving any documents from the database.Use [`limit()`](https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit) to maximize performance and prevent MongoDB from returning more results than required for processing.The [`cursor.limit()`](https://docs.mongodb.com/manual/reference/method/cursor.limit/#cursor.limit) method has the following prototype form:`db.collection.find(<query>).limit(<number>)`


### 创建索引

```
> db.col.ensureIndex({"user_id":1})
{
	"createdCollectionAutomatically" : false,
	"numIndexesBefore" : 1,
	"numIndexesAfter" : 2,
	"ok" : 1
}
> db.col.ensureIndex({"last_login_time":1})
{
	"createdCollectionAutomatically" : false,
	"numIndexesBefore" : 2,
	"numIndexesAfter" : 3,
	"ok" : 1
}
> db.cv_videos.ensureIndex({"video_created_at":1})
> db.cv_videos.ensureIndex({"video_id":1})
> db.cv_videos.getIndexes()
[
	{
		"v" : 2,
		"key" : {
			"_id" : 1
		},
		"name" : "_id_",
		"ns" : "botdb.cv_videos"
	},
	{
		"v" : 2,
		"key" : {
			"video_created_at" : 1
		},
		"name" : "video_created_at_1",
		"ns" : "botdb.cv_videos"
	},
	{
		"v" : 2,
		"key" : {
			"video_id" : 1
		},
		"name" : "video_id_1",
		"ns" : "botdb.cv_videos"
	}
]
>
```

### MongoDB CRUD

#### Related

切换数据库

```
> use botdb
switched to db botdb
```

#### Create



#### Retrive

```
> db.cv_users.count()
11275798
> db.cv_videos.findOne({"video_id":'96832176'}) 
{
	"_id" : ObjectId("5aaa2d25587809935c35769e"),
	"user_id" : "0",
	"video_id" : "96832176",  //  插入的是String
	"video_activity_status" : 0,
	"video_digest_status" : 0,
	"video_created_at" : "2018-01-15 15:00:30"
}
> db.cv_videos.findOne({"video_id":5}) 
{
	"_id" : ObjectId("5aab1f008e85ce713b25d83c"),
	"video_id" : NumberLong(5),   // 如果插入的时候用的是long 值，在这显示NumberLong(5)
	"video_created_at" : "2018-03-16 09:33:52",
	"video_digest_status" : 0,  // 如果在这里插入的是int 值，那么这里不显示单位
	"video_activity_status" : 0,
	"user_id" : NumberLong(4)
}
>
```

Find().into()

```
 BasicDBObject in = new BasicDBObject("$elemMatch", new BasicDBObject("$eq", "B. Eng."));
 BasicDBObjectBuilder builder = BasicDBObjectBuilder.start().add("qualifications);
```

#### Update



## Update Operators

### Fields

| Name                                                         | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`$currentDate`](https://docs.mongodb.com/manual/reference/operator/update/currentDate/#up._S_currentDate) | Sets the value of a field to current date, either as a Date or a Timestamp. |
| [`$inc`](https://docs.mongodb.com/manual/reference/operator/update/inc/#up._S_inc) | Increments the value of the field by the specified amount.   |
| [`$min`](https://docs.mongodb.com/manual/reference/operator/update/min/#up._S_min) | Only updates the field if the specified value is less than the existing field value. |
| [`$max`](https://docs.mongodb.com/manual/reference/operator/update/max/#up._S_max) | Only updates the field if the specified value is greater than the existing field value. |
| [`$mul`](https://docs.mongodb.com/manual/reference/operator/update/mul/#up._S_mul) | Multiplies the value of the field by the specified amount.   |
| [`$rename`](https://docs.mongodb.com/manual/reference/operator/update/rename/#up._S_rename) | Renames a field.                                             |
| [`$set`](https://docs.mongodb.com/manual/reference/operator/update/set/#up._S_set) | Sets the value of a field in a document.                     |
| [`$setOnInsert`](https://docs.mongodb.com/manual/reference/operator/update/setOnInsert/#up._S_setOnInsert) | Sets the value of a field if an update results in an insert of a document. Has no effect on update operations that modify existing documents. |
| [`$unset`](https://docs.mongodb.com/manual/reference/operator/update/unset/#up._S_unset) | Removes the specified field from a document.                 |

### Array

#### Operators

| Name                                                         | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`$`](https://docs.mongodb.com/manual/reference/operator/update/positional/#up._S_) | Acts as a placeholder to update the first element that matches the query condition. |
| [`$[\]`](https://docs.mongodb.com/manual/reference/operator/update/positional-all/#up._S_[]) | Acts as a placeholder to update all elements in an array for the documents that match the query condition. |
| [`$[\]`](https://docs.mongodb.com/manual/reference/operator/update/positional-filtered/#up._S_[%3Cidentifier%3E]) | Acts as a placeholder to update all elements that match the `arrayFilters` condition for the documents that match the query condition. |
| [`$addToSet`](https://docs.mongodb.com/manual/reference/operator/update/addToSet/#up._S_addToSet) | Adds elements to an array only if they do not already exist in the set. |
| [`$pop`](https://docs.mongodb.com/manual/reference/operator/update/pop/#up._S_pop) | Removes the first or last item of an array.                  |
| [`$pull`](https://docs.mongodb.com/manual/reference/operator/update/pull/#up._S_pull) | Removes all array elements that match a specified query.     |
| [`$push`](https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push) | Adds an item to an array.                                    |
| [`$pullAll`](https://docs.mongodb.com/manual/reference/operator/update/pullAll/#up._S_pullAll) | Removes all matching values from an array.                   |

#### Modifiers

| Name                                                         | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`$each`](https://docs.mongodb.com/manual/reference/operator/update/each/#up._S_each) | Modifies the [`$push`](https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push) and [`$addToSet`](https://docs.mongodb.com/manual/reference/operator/update/addToSet/#up._S_addToSet) operators to append multiple items for array updates. |
| [`$position`](https://docs.mongodb.com/manual/reference/operator/update/position/#up._S_position) | Modifies the [`$push`](https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push) operator to specify the position in the array to add elements. |
| [`$slice`](https://docs.mongodb.com/manual/reference/operator/update/slice/#up._S_slice) | Modifies the [`$push`](https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push) operator to limit the size of updated arrays. |
| [`$sort`](https://docs.mongodb.com/manual/reference/operator/update/sort/#up._S_sort) | Modifies the [`$push`](https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push) operator to reorder documents stored in an array. |

### Bitwise

| Name                                                         | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`$bit`](https://docs.mongodb.com/manual/reference/operator/update/bit/#up._S_bit) | Performs bitwise `AND`, `OR`, and `XOR` updates of integer values. |

#### Delete

```
> db.cv_videos.deleteOne({"video_id":5})
{ "acknowledged" : true, "deletedCount" : 1 }
> db.cv_videos.deleteMany({}) // 全部删除
```

**remove() 方法已经过时了，现在官方推荐使用 deleteOne() 和 deleteMany() 方法**

如删除集合下全部文档：

```
db.inventory.deleteMany({})
```

删除 status 等于 A 的全部文档：

```
db.inventory.deleteMany({ status : "A" })
```

删除 status 等于 D 的一个文档：

```
db.inventory.deleteOne( { status: "D" } )
```

### Pymongo

```
client = MongoClient('mongodb://10.25.172.135:27017/')
db = client.botdb
cv_users = db.cv_users

cv_users.update_one({'user_id': uid}, {'$set': {'last_login_time': str(last_login_date) + " " + randomTime}})
cv_users.update_one({'user_id': uid}, {'$set': {'last_login_time': ts, 'active_status': 'ACTIVE'}})

for post in cv_videos.find({"video_created_at": {"$gt": "2018-01-31 23:59:59", "$lt": "2018-03-01 00:00:00"}}).sort("video_created_at"):


cv_videos.drop()


cv_videos.insert_one({'video_id': vid, 'user_id': uid, 'video_created_at': created_at,
                                  "video_digest_status": int(isPublished), "video_activity_status": int(isActivity)})
                                  


# coding:utf-8
# upsert 的用法
if __name__ == '__main__':
    # 用来更新用户状态的改变，只按照尾号进行记录
    from pymongo import MongoClient

    client = MongoClient('mongodb://127.0.0.1:27017/')
    db = client.botdb

    cv_user_states = db.cv_user_states
    cv_user_states.update({"from_active_status": 1}, {"$inc": {"count": 1}}, upsert=True)


```

### Mongo tutorial UTB

```
https://www.youtube.com/watch?v=pWbMrx5rVBE

> cls // 清屏

> show dbs  // 显示所有db
admin   0.000GB
botdb   0.000GB
config  0.000GB
local   0.000GB

> use botdb  // 创建一个db，并切换到上面
switched to db botdb

> db  // 查看当前所在哪个db
botdb

> db.createUser({user:"brad",pwd:"1234",roles:["readWrite", "dbAdmin"]});   // 创建一个用户
Successfully added user: { "user" : "brad", "roles" : [ "readWrite", "dbAdmin" ] }

> db.getUsers()  // 查看当前所在db 的所有用户
[
	{
		"_id" : "test.brad",
		"user" : "brad",
		"db" : "test",
		"roles" : [
			{
				"role" : "readWrite",
				"db" : "test"
			},
			{
				"role" : "dbAdmin",
				"db" : "test"
			}
		]
	}
]

> db.dropUser("brad")
true

> db.createCollection("customers")  // 创建collection
{ "ok" : 1 }

> show collections  // 查看所有collection
customers

> db.customers.insert({first_name:"John", last_name:"Doe"});  // 插入
WriteResult({ "nInserted" : 1 })

> db.customers.find()  // 查找一个document
{ "_id" : ObjectId("5abaef900089b6c92ad69de9"), "first_name" : "John", "last_name" : "Doe" }

> db.customers.insert([{first_name:"Stevent",last_name:"Smith"},{first_name:"Mary",last_name:"Mapple", gender:"female"}]);  // 可以直接插入多个列的值
BulkWriteResult({
	"writeErrors" : [ ],
	"writeConcernErrors" : [ ],
	"nInserted" : 2,
	"nUpserted" : 0,
	"nMatched" : 0,
	"nModified" : 0,
	"nRemoved" : 0,
	"upserted" : [ ]
})

> db.customers.find().pretty()  // help function
{
	"_id" : ObjectId("5abaef900089b6c92ad69de9"),
	"first_name" : "John",
	"last_name" : "Doe"
}
{
	"_id" : ObjectId("5abaf03f4475b1e20d2a3908"),
	"first_name" : "Stevent",
	"last_name" : "Smith"
}
{
	"_id" : ObjectId("5abaf03f4475b1e20d2a3909"),
	"first_name" : "Mary",
	"last_name" : "Mapple"
}

> db.customers.update({first_name:"John"},{first_name:"John",last_name:"Johnson"})  // 更新一个document，但是要全部信息再输入一遍，update 需要接收两个参数{},{}
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

> db.customers.update({first_name:"John"},{$set:{last_name:"Joey"}})  // 不用把全部的重新输入一遍，直接更新
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

> db.customers.update({first_name:"John"},{$set:{age:45}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })  // 也可以直接更新一个全新的属性

> db.customers.update({first_name:"John"},{$inc:{age:5}})  // 利用inc 来增加一个数字类型的值，5 是原数据上加5，John 的age 属性变为50
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 }) 

> db.customers.update({first_name:"John"},{$unset:{age:1}})  // 删除一个field，利用1 或者true 都可以
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

> db.customers.update({first_name:"John"},{$unset:{age:true}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

> db.customers.update({first_name:"NotInDBYet"},{first_name:"NotInDBYet",last_name:"Nlast_name"});  // 更新一个没在db 中的数据不会插入
WriteResult({ "nMatched" : 0, "nUpserted" : 0, "nModified" : 0 })

> db.customers.update({first_name:"NotInDBYet"},{first_name:"NotInDBYet",last_name:"Nlast_name"}, {upsert:true});  // 如果不存在就插入，利用upsert:true 为第三个参数
WriteResult({
	"nMatched" : 0,
	"nUpserted" : 1,
	"nModified" : 0,
	"_id" : ObjectId("5abaf56cbfa11b5aec4839d0")
})

> db.customers.update({first_name:"John"},{$rename:{"gender":"sex"}});  // 重新定义一个field 的列，列名就会更改为sex
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

> db.customers.remove({first_name:"NotInDBYet"});  // 删除数据
WriteResult({ "nRemoved" : 1 })

> db.customers.remove({first_name:"John"},{justOne:true});  // 利用justOne 来确保只删除一条数据
WriteResult({ "nRemoved" : 1 })

> db.customers.find({first_name:"Mary"}).pretty();  // 按照条件查找document
{
	"_id" : ObjectId("5abaf03f4475b1e20d2a3909"),
	"first_name" : "Mary",
	"last_name" : "Mapple"
}

> db.customers.find({$or:[{first_name:"Mary"},{first_name:"Stevent"}]});  // 按照`或` 的关系查找数据，$or 后面的必须是一个array，[]
{ "_id" : ObjectId("5abaf03f4475b1e20d2a3908"), "first_name" : "Stevent", "last_name" : "Smith" }
{ "_id" : ObjectId("5abaf03f4475b1e20d2a3909"), "first_name" : "Mary", "last_name" : "Mapple" }

> db.cv_users.count({"$and":[{"active_status":"RETURN"}, {"works_status":{$exists:false}}]});
700


```



